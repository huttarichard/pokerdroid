# Safe and Nested Subgame Solving for Imperfect-Information Games* 

Noam Brown<br>Computer Science Department<br>Carnegie Mellon University<br>Pittsburgh, PA 15217<br>noamb@cs.cmu.edu

Tuomas Sandholm<br>Computer Science Department<br>Carnegie Mellon University<br>Pittsburgh, PA 15217<br>sandholm@cs.cmu.edu


#### Abstract

In imperfect-information games, the optimal strategy in a subgame may depend on the strategy in other, unreached subgames. Thus a subgame cannot be solved in isolation and must instead consider the strategy for the entire game as a whole, unlike perfect-information games. Nevertheless, it is possible to first approximate a solution for the whole game and then improve it by solving individual subgames. This is referred to as subgame solving. We introduce subgame-solving techniques that outperform prior methods both in theory and practice. We also show how to adapt them, and past subgame-solving techniques, to respond to opponent actions that are outside the original action abstraction; this significantly outperforms the prior state-of-the-art approach, action translation. Finally, we show that subgame solving can be repeated as the game progresses down the game tree, leading to far lower exploitability. These techniques were a key component of Libratus, the first AI to defeat top humans in heads-up no-limit Texas hold'em poker.


## 1 Introduction

Imperfect-information games model strategic settings that have hidden information. They have a myriad of applications including negotiation, auctions, cybersecurity, and physical security.

In perfect-information games, determining the optimal strategy at a decision point only requires knowledge of the game tree's current node and the remaining game tree beyond that node (the subgame rooted at that node). This fact has been leveraged by nearly every AI for perfect-information games, including AIs that defeated top humans in chess [9] and Go [32]. In checkers, the ability to decompose the game into smaller independent subgames was even used to solve the entire game [30]. However, it is not possible to determine a subgame's optimal strategy in an imperfect-information game using only knowledge of that subgame, because the game tree's exact node is typically unknown. Instead, the optimal strategy may depend on the value an opponent could have received in some other, unreached subgame. Although this is counter-intuitive, we provide a demonstration in Section 2
Rather than rely on subgame decomposition, past approaches for imperfect-information games typically solved the game as a whole upfront. For example, heads-up limit Texas hold'em, a relatively simple form of poker with $10^{13}$ decision points, was essentially solved without decomposition [2]. However, this approach cannot extend to larger games, such as heads-up no-limit Texas hold'em-the primary benchmark in imperfect-information game solving-which has $10^{161}$ decision points [18].

[^0]The standard approach to computing strategies in such large games is to first generate an abstraction of the game, which is a smaller version of the game that retains as much as possible the strategic characteristics of the original game [27, 29, 28]. For example, a continuous action space might be discretized. This abstract game is solved and its solution is used when playing the full game by mapping states in the full game to states in the abstract game. We refer to the solution of an abstraction (or more generally any approximate solution to a game) as a blueprint strategy.

In heavily abstracted games, a blueprint may be far from the true solution. Subgame solving attempts to improve upon the blueprint by solving in real time a more fine-grained abstraction for an encountered subgame, while fitting its solution within the overarching blueprint.

## 2 Coin Toss

In this section we provide intuition for why an imperfect-information subgame cannot be solved in isolation. We demonstrate this in a simple game we call Coin Toss, shown in Figure 1a, which will be used as a running example throughout the paper.

Coin Toss is played between players $P_{1}$ and $P_{2}$. The figure shows rewards only for $P_{1} ; P_{2}$ always receives the negation of $P_{1}$ 's reward. A coin is flipped and lands either Heads or Tails with equal probability, but only $P_{1}$ sees the outcome. $P_{1}$ then chooses between actions "Sell" and "Play." The Sell action leads to a subgame whose details are not important, but the expected value (EV) of choosing the Sell action will be important. (For simplicity, one can equivalently assume in this section that Sell leads to an immediate terminal reward, where the value depends on whether the coin landed Heads or Tails). If the coin lands Heads, it is considered lucky and $P_{1}$ receives an EV of $\$ 0.50$ for choosing Sell. On the other hand, if the coin lands Tails, it is considered unlucky and $P_{1}$ receives an EV of $-\$ 0.50$ for action Sell. (That is, $P_{1}$ must on average pay $\$ 0.50$ to get rid of the coin). If $P_{1}$ instead chooses Play, then $P_{2}$ may guess how the coin landed. If $P_{2}$ guesses correctly, then $P_{1}$ receives a reward of $-\$ 1$. If $P_{2}$ guesses incorrectly, then $P_{1}$ receives $\$ 1 . P_{2}$ may also forfeit, which should never be chosen but will be relevant in later sections. We wish to determine the optimal strategy for $P_{2}$ in the subgame $S$ that occurs after $P_{1}$ chooses Play, shown in Figure 1 a.
![](https://cdn.mathpix.com/cropped/2025_02_19_a9f0306e3dfd4c0620f2g-02.jpg?height=522&width=1010&top_left_y=1406&top_left_x=552)

Figure 1: (a) The example game of Coin Toss. "C" represents a chance node. $S$ is a Player $2\left(P_{2}\right)$ subgame. The dotted line between the two $P_{2}$ nodes means that $P_{2}$ cannot distinguish between them. (b) The public game tree of Coin Toss. The two outcomes of the coin flip are only observed by $P_{1}$.

Were $P_{2}$ to always guess Heads, $P_{1}$ would receive $\$ 0.50$ for choosing Sell when the coin lands Heads, and $\$ 1$ for Play when it lands Tails. This would result in an average of $\$ 0.75$ for $P_{1}$. Alternatively, were $P_{2}$ to always guess Tails, $P_{1}$ would receive $\$ 1$ for choosing Play when the coin lands Heads, and $-\$ 0.50$ for choosing Sell when it lands Tails. This would result in an average reward of $\$ 0.25$ for $P_{1}$. However, $P_{2}$ would do even better by guessing Heads with $25 \%$ probability and Tails with $75 \%$ probability. In that case, $P_{1}$ could only receive $\$ 0.50$ (on average) by choosing Play when the coin lands Heads-the same value received for choosing Sell. Similarly, $P_{1}$ could only receive $-\$ 0.50$ by choosing Play when the coin lands Tails, which is the same value received for choosing Sell. This would yield an average reward of $\$ 0$ for $P_{1}$. It is easy to see that this is the best $P_{2}$ can do, because $P_{1}$ can average $\$ 0$ by always choosing Sell. Therefore, choosing Heads with $25 \%$ probability and Tails with $75 \%$ probability is an optimal strategy for $P_{2}$ in the "Play" subgame.

Now suppose the coin is considered lucky if it lands Tails and unlucky if it lands Heads. That is, the expected reward for selling the coin when it lands Heads is now $-\$ 0.50$ and when it lands Tails is now $\$ 0.50$. It is easy to see that $P_{2}$ 's optimal strategy for the "Play" subgame is now to guess Heads with $75 \%$ probability and Tails with $25 \%$ probability. This shows that a player's optimal strategy in a subgame can depend on the strategies and outcomes in other parts of the game. Thus, one cannot solve a subgame using information about that subgame alone. This is the central challenge of imperfect-information games as opposed to perfect-information games.

## 3 Notation and Background

This paper focuses on two-player zero-sum games. In a two-player zero-sum extensive-form game there are two players, $\mathcal{P}=\{1,2\} . H$ is the set of all possible nodes, represented as a sequence of actions. $A(h)$ is the actions available in a node and $P(h) \in \mathcal{P} \cup c$ is the player who acts at that node, where $c$ denotes chance. Chance plays an action $a \in A(h)$ with a fixed probability. If action $a \in A(h)$ leads from $h$ to $h^{\prime}$, then we write $h \cdot a=h^{\prime}$. If a sequence of actions leads from $h$ to $h^{\prime}$, then we write $h \sqsubset h^{\prime}$. The set of nodes $Z \subseteq H$ are terminal nodes. For each player $i \in \mathcal{P}$, there is a payoff function $u_{i}: Z \rightarrow \Re$ where $u_{1}=-u_{2}$.

Imperfect information is represented by information sets (infosets). Every node $h \in H$ belongs to exactly one infoset for each player. For any infoset $I_{i}$, nodes $h, h^{\prime} \in I_{i}$ are indistinguishable to player $i$. Thus the same player must act at all the nodes in an infoset, and the same actions must be available. Let $P\left(I_{i}\right)$ and $A\left(I_{i}\right)$ be such that all $h \in I_{i}, P\left(I_{i}\right)=P(h)$ and $A\left(I_{i}\right)=A(h)$.
A strategy $\sigma_{i}\left(I_{i}\right)$ is a probability vector over $A\left(I_{i}\right)$ for infosets where $P\left(I_{i}\right)=i$. The probability of action $a$ is denoted by $\sigma_{i}\left(I_{i}, a\right)$. For all $h \in I_{i}, \sigma_{i}(h)=\sigma_{i}\left(I_{i}\right)$. A full-game strategy $\sigma_{i} \in \Sigma_{i}$ defines a strategy for each player $i$ infoset. A strategy profile $\sigma$ is a tuple of strategies, one for each player. The expected payoff for player $i$ if all players play the strategy profile $\left\langle\sigma_{i}, \sigma_{-i}\right\rangle$ is $u_{i}\left(\sigma_{i}, \sigma_{-i}\right)$, where $\sigma_{-i}$ denotes the strategies in $\sigma$ of all players other than $i$.

Let $\pi^{\sigma}(h)=\prod_{h^{\prime} \cdot a \sqsubseteq h} \sigma_{P\left(h^{\prime}\right)}\left(h^{\prime}, a\right)$ denote the probability of reaching $h$ if all players play according to $\sigma . \pi_{i}^{\sigma}(h)$ is the contribution of player $i$ to this probability (that is, the probability of reaching $h$ if chance and all players other than $i$ always chose actions leading to $h$ ). $\pi_{-i}^{\sigma}(h)$ is the contribution of all players, and chance, other than $i$. We similarly define $\pi^{\sigma}\left(h, h^{\prime}\right)$ is the probability of reaching $h^{\prime}$ given that $h$ has been reached, and 0 if $h \not \subset h^{\prime}$. This papers focuses on perfect-recall games, where a player never forgets past information. Thus, for every $I_{i}, \forall h, h^{\prime} \in I_{i}, \pi_{i}^{\sigma}(h)=\pi_{i}^{\sigma}\left(h^{\prime}\right)$. We define $\pi_{i}^{\sigma}\left(I_{i}\right)=\pi_{i}^{\sigma}(h)$ for $h \in I_{i}$. Also, $I_{i}^{\prime} \sqsubset I_{i}$ if for some $h^{\prime} \in I_{i}^{\prime}$ and some $h \in I_{i}, h^{\prime} \sqsubset h$. Similarly, $I_{i}^{\prime} \cdot a \sqsubset I_{i}$ if $h^{\prime} \cdot a \sqsubset h$.
A Nash equilibrium [25] is a strategy profile $\sigma^{*}$ where no player can improve by shifting to a different strategy, so $\sigma^{*}$ satisfies $\forall i, u_{i}\left(\sigma_{i}^{*}, \sigma_{-i}^{*}\right)=\max _{\sigma_{i}^{\prime} \in \Sigma_{i}} u_{i}\left(\sigma_{i}^{\prime}, \sigma_{-i}^{*}\right)$. An $\epsilon$-Nash equilibrium is a strategy profile $\sigma^{*}$ such that $\forall i, u_{i}\left(\sigma_{i}^{*}, \sigma_{-i}^{*}\right)+\epsilon \geq \max _{\sigma_{i}^{\prime} \in \Sigma_{i}} u_{i}\left(\sigma_{i}^{\prime}, \sigma_{-i}^{*}\right)$. A best response $B R\left(\sigma_{-i}\right)$ is a strategy for player $i$ that is optimal against $\sigma_{-i}$. Formally, $B R\left(\sigma_{-i}\right)$ satisfies $u_{i}\left(B R\left(\sigma_{-i}\right), \sigma_{-i}\right)=$ $\max _{\sigma_{i}^{\prime} \in \Sigma_{i}} u_{i}\left(\sigma_{i}^{\prime}, \sigma_{-i}\right)$. In a two-player zero-sum game, the $\operatorname{exploitability} \exp \left(\sigma_{i}\right)$ of a strategy $\sigma_{i}$ is how much worse $\sigma_{i}$ does against an opponent best response than a Nash equilibrium strategy would do. Formally, exploitability of $\sigma_{i}$ is $u_{i}\left(\sigma^{*}\right)-u_{i}\left(\sigma_{i}, B R\left(\sigma_{i}\right)\right)$, where $\sigma^{*}$ is a Nash equilibrium.

The expected value of a node $h$ when players play according to $\sigma$ is $v_{i}^{\sigma}(h)=\sum_{z \in Z}\left(\pi^{\sigma}(h, z) u_{i}(z)\right)$. An infoset's value is the weighted average of the values of the nodes in the infoset, where a node is weighed by the player's belief that she is in that node. Formally, $v_{i}^{\sigma}\left(I_{i}\right)=\frac{\sum_{h \in I_{i}}\left(\pi_{-i}^{\sigma}(h) v_{i}^{\sigma}(h)\right)}{\sum_{h \in I_{i}} \pi_{-i}^{\sigma}(h)}$ and $v_{i}^{\sigma}\left(I_{i}, a\right)=\frac{\sum_{h \in I_{i}}\left(\pi_{-i}^{\sigma}(h) v_{i}^{\sigma}(h \cdot a)\right)}{\sum_{h \in I_{i}} \pi_{-i}^{\sigma}(h)}$. A counterfactual best response [24] $C B R\left(\sigma_{-i}\right)$ is a best response that also maximizes value in unreached infosets. Specifically, a counterfactual best response is a best response $\sigma_{i}$ with the additional condition that if $\sigma_{i}\left(I_{i}, a\right)>0$ then $v_{i}^{\sigma}\left(I_{i}, a\right)=$ $\max _{a^{\prime}} v_{i}^{\sigma}\left(I_{i}, a^{\prime}\right)$. We further define counterfactual best response value $C B V^{\sigma-i}\left(I_{i}\right)$ as the value player $i$ expects to achieve by playing according to $C B R\left(\sigma_{-i}\right)$, having already reached infoset $I_{i}$. Formally, $C B V^{\sigma_{-i}}\left(I_{i}\right)=v_{i}^{\left\langle C B R\left(\sigma_{-i}\right), \sigma_{-i}\right\rangle}\left(I_{i}\right)$ and $C B V^{\sigma_{-i}}\left(I_{i}, a\right)=v_{i}^{\left\langle C B R\left(\sigma_{-i}\right), \sigma_{-i}\right\rangle}\left(I_{i}, a\right)$.
An imperfect-information subgame, which we refer to simply as a subgame in this paper, can in most cases (but not all) be described as including all nodes which share prior public actions (that is,
actions viewable to both players). In poker, for example, a subgame is uniquely defined by a sequence of bets and public board cards. Figure 1b shows the public game tree of Coin Toss. Formally, an imperfect-information subgame is a set of nodes $S \subseteq H$ such that for all $h \in S$, if $h \sqsubset h^{\prime}$, then $h^{\prime} \in S$, and for all $h \in S$ and all $i \in \mathcal{P}$, if $h^{\prime} \in I_{i}(h)$ then $h^{\prime} \in S$. Define $S_{\text {top }}$ as the set of earliest-reachable nodes in $S$. That is, $h \in S_{\text {top }}$ if $h \in S$ and $h^{\prime} \notin S$ for any $h^{\prime} \sqsubset h$.

## 4 Prior Approaches to Subgame Solving

This section reviews prior techniques for subgame solving in imperfect-information games, which we build upon. Throughout this section, we refer to the Coin Toss game shown in Figure 1 a .
As discussed in Section 1, a standard approach to dealing with large imperfect-information games is to solve an abstraction of the game. The abstract solution is a (probably suboptimal) strategy profile in the full game. We refer to this full-game strategy profile as the blueprint. The goal of subgame solving is to improve upon the blueprint by changing the strategy only in a subgame. While the blueprint is frequently a Nash equilibrium (or approximate Nash equilibrium) in some abstraction of the full game, our techniques do not assume this. The blueprint can in fact be any arbitrary strategy in the full game.
![](https://cdn.mathpix.com/cropped/2025_02_19_a9f0306e3dfd4c0620f2g-04.jpg?height=359&width=606&top_left_y=975&top_left_x=754)

Figure 2: The blueprint we refer to in the game of Coin Toss. The Sell action leads to a subgame that is not displayed. Probabilities are shown for all actions. The dotted line means the two $P_{2}$ nodes share an infoset. The EV of each $P_{1}$ action is also shown.

Assume that a blueprint $\sigma$ (shown in Figure 2) has already been computed for Coin Toss in which $P_{1}$ chooses Play $\frac{3}{4}$ of the time with Heads and $\frac{1}{2}$ of the time with Tails, and $P_{2}$ chooses Heads $\frac{1}{2}$ of the time, Tails $\frac{1}{4}$ of the time, and Forfeit $\frac{1}{4}$ of the time after $P_{1}$ chooses Play. ${ }^{2}$ The details of the blueprint in the Sell subgame are not relevant in this section, but the EV for choosing the Sell action is relevant. We assume that if $P_{1}$ chose the Sell action and played optimally thereafter, then she would receive an expected payoff of 0.5 if the coin is Heads, and -0.5 if the coin is Tails. We will attempt to improve $P_{2}$ 's strategy in the subgame $S$ that follows $P_{1}$ choosing Play.

### 4.1 Unsafe Subgame Solving

We first review the most intuitive form of subgame solving, which we refer to as Unsafe subgame solving [1, 14, 15, 12]. This form of subgame solving assumes both players played according to the blueprint prior to reaching the subgame. That defines a probability distribution over the nodes at the root of the subgame $S$, representing the probability that the true game state matches that node. A strategy for the subgame is then calculated which assumes that this distribution is correct.
In all subgame solving algorithms, an augmented subgame containing $S$ and a few additional nodes is solved to determine the strategy for $S$. Applying Unsafe subgame solving to the blueprint in Coin Toss (after $P_{1}$ chooses Play) means solving the augmented subgame shown in Figure 3 a

Specifically, the augmented subgame consists of only an initial chance node and $S$. The initial chance node reaches $h \in S_{\text {top }}$ with probability $\frac{\pi^{\sigma}(h)}{\sum_{h^{\prime} \in S_{\text {top }}} \pi^{\sigma}\left(h^{\prime}\right)}$. The augmented subgame is solved and its strategy for $P_{2}$ is used in $S$ rather than the blueprint strategy.

[^1]![](https://cdn.mathpix.com/cropped/2025_02_19_a9f0306e3dfd4c0620f2g-05.jpg?height=475&width=1283&top_left_y=218&top_left_x=416)

Figure 3: The augmented subgames solved to find a $P_{2}$ strategy in the Play subgame of Coin Toss.

Unsafe subgame solving lacks theoretical solution quality guarantees and there are many situations where it performs extremely poorly. Indeed, if it were applied to the blueprint of Coin Toss then $P_{2}$ would always choose Heads-which $P_{1}$ could exploit severely by only choosing Play with Tails. Despite the lack of theoretical guarantees and potentially bad performance, Unsafe subgame solving is simple and can sometimes produce low-exploitability strategies, as we show later.
We now move to discussing safe subgame-solving techniques, that is, ones that ensure that the exploitability of the strategy is no higher than that of the blueprint strategy.

### 4.2 Subgame Resolving

In subgame Resolving [8], a safe strategy is computed for $P_{2}$ in the subgame by solving the augmented subgame shown in Figure 3b producing an equilibrium strategy $\sigma^{S}$. This augmented subgame differs from Unsafe subgame solving by giving $P_{1}$ the option to "opt out" from entering $S$ and instead receive the EV of playing optimally against $P_{2}$ 's blueprint strategy in $S$.
Specifically, the augmented subgame for Resolving differs from unsafe subgame solving as follows. For each $h_{\text {top }} \in S_{\text {top }}$ we insert a new $P_{1}$ node $h_{r}$, which exists only in the augmented subgame, between the initial chance node and $h_{\text {top }}$. The set of these $h_{r}$ nodes is $S_{r}$. The initial chance node connects to each node $h_{r} \in S_{r}$ in proportion to the probability that player $P_{1}$ could reach $h_{\text {top }}$ if $P_{1}$ tried to do so (that is, in proportion to $\pi_{-1}^{\sigma}\left(h_{\text {top }}\right)$ ). At each node $h_{r} \in S_{r}, P_{1}$ has two possible actions. Action $a_{S}^{\prime}$ leads to $h_{\text {top }}$, while action $a_{T}^{\prime}$ leads to a terminal payoff that awards the value of playing optimally against $P_{2}$ 's blueprint strategy, which is $C B V^{\sigma_{2}}\left(I_{1}\left(h_{\text {top }}\right)\right)$. In the blueprint of Coin Toss, $P_{1}$ choosing Play after the coin lands Heads results in an EV of 0 , and $\frac{1}{2}$ if the coin is Tails. Therefore, $a_{T}^{\prime}$ leads to a terminal payoff of 0 for Heads and $\frac{1}{2}$ for Tails. After the equilibrium strategy $\sigma^{S}$ is computed in the augmented subgame, $P_{2}$ plays according to the computed subgame strategy $\sigma_{2}^{S}$ rather than the blueprint strategy when in $S$. The $P_{1}$ strategy $\sigma_{1}^{S}$ is not used.
Clearly $P_{1}$ cannot do worse than always picking action $a_{T}^{\prime}$ (which awards the highest EV $P_{1}$ could achieve against $P_{2}$ 's blueprint). But $P_{1}$ also cannot do better than always picking $a_{T}^{\prime}$, because $P_{2}$ could simply play according to the blueprint in $S$, which means action $a_{S}^{\prime}$ would give the same EV to $P_{1}$ as action $a_{T}^{\prime}$ (if $P_{1}$ played optimally in $S$ ). In this way, the strategy for $P_{2}$ in $S$ is pressured to be no worse than that of the blueprint. In Coin Toss, if $P_{2}$ were to always choose Heads (as was the case in Unsafe subgame solving), then $P_{1}$ would always choose $a_{T}^{\prime}$ with Heads and $a_{S}^{\prime}$ with Tails.

Resolving guarantees that $P_{2}$ 's exploitability will be no higher than the blueprint's (and may be better). However, it may miss opportunities for improvement. For example, if we apply Resolving to the example blueprint in Coin Toss, one solution to the augmented subgame is the blueprint itself, so $P_{2}$ may choose Forfeit $25 \%$ of the time even though Heads and Tails dominate that action. Indeed, the original purpose of Resolving was not to improve upon a blueprint strategy in a subgame, but rather to compactly store it by keeping only the EV at the root of the subgame and then reconstructing the strategy in real time when needed rather than storing the whole subgame strategy.

Maxmargin subgame solving [24], discussed in Appendix A. can improve performance by defining a margin $M^{\sigma^{S}}\left(I_{1}\right)=C B V^{\sigma_{2}}\left(I_{1}\right)-C B V^{\sigma_{2}^{S}}\left(I_{1}\right)$ for each $I_{1} \in S_{\text {top }}$ and maximizing
$\min _{I_{1} \in S_{\text {top }}} M^{\sigma^{S}}\left(I_{1}\right)$. Resolving only makes all margins nonnegative. However, Maxmargin does worse in practice when using estimates of equilibrium values as discussed in Section 6

## 5 Reach Subgame Solving

All of the subgame-solving techniques described in Section 4 only consider the target subgame in isolation, which can lead to suboptimal strategies. For example, Maxmargin solving applied to $S$ in Coin Toss results in $P_{2}$ choosing Heads with probability $\frac{5}{8}$ and Tails with $\frac{3}{8}$ in $S$. This results in $P_{1}$ receiving an EV of $-\frac{1}{4}$ by choosing Play in the Heads state, and an EV of $\frac{1}{4}$ in the Tails state. However, $P_{1}$ could simply always choose Sell in the Heads state (earning an EV of 0.5) and Play in the Tails state and receive an EV of $\frac{3}{8}$ for the entire game. In this section we introduce Reach subgame solving, an improvement to past subgame-solving techniques that considers what the opponent could have alternatively received from other subgames ${ }^{3}$ For example, a better strategy for $P_{2}$ would be to choose Heads with probability $\frac{3}{4}$ and Tails with probability $\frac{1}{4}$. Then $P_{1}$ is indifferent between choosing Sell and Play in both cases and overall receives an expected payoff of 0 for the whole game.

However, that strategy is only optimal if $P_{1}$ would indeed achieve an EV of 0.5 for choosing Sell in the Heads state and -0.5 in the Tails state. That would be the case if $P_{2}$ played according to the blueprint in the Sell subgame (which is not shown), but in reality we would apply subgame solving to the Sell subgame if the Sell action were taken, which would change $P_{2}$ 's strategy there and therefore $P_{1}$ 's EVs. Applying subgame solving to any subgame encountered during play is equivalent to applying it to all subgames independently. Thus, we must consider that the EVs from other subgames may differ from what the blueprint says because subgame solving would be applied to them as well.
![](https://cdn.mathpix.com/cropped/2025_02_19_a9f0306e3dfd4c0620f2g-06.jpg?height=413&width=1296&top_left_y=1189&top_left_x=409)

Figure 4: Left: A modified game of Coin Toss with two subgames. The nodes $C_{1}$ and $C_{2}$ are public chance nodes whose outcomes are seen by both $P_{1}$ and $P_{2}$. Right: An augmented subgame for one of the subgames according to Reach subgame solving. If only one of the subgames is being solved, then the alternative payoff for Heads can be at most 1. However, if both are solved independently, then the gift must be split among the subgames and must sum to at most 1 . For example, the alternative payoff in both subgames can be 0.5 .

As an example of this issue, consider the game shown in Figure 4 which contains two identical subgames $S_{1}$ and $S_{2}$ where the blueprint has $P_{2}$ pick Heads and Tails with $50 \%$ probability. The Sell action leads to an EV of 0.5 from the Heads state, while Play leads to an EV of 0 . If we were to solve just $S_{1}$, then $P_{2}$ could afford to always choose Tails in $S_{1}$, thereby letting $P_{1}$ achieve an EV of 1 for reaching that subgame from Heads because, due to the chance node $C_{1}, S_{1}$ is only reached with $50 \%$ probability. Thus, $P_{1}$ 's EV for choosing Play would be 0.5 from Heads and -0.5 from Tails, which is optimal. We can achieve this strategy in $S_{1}$ by solving an augmented subgame in which the alternative payoff for Heads is 1 . In that augmented subgame, $P_{2}$ always choosing Tails would be a solution (though not the only solution).

However, if the same reasoning were applied independently to $S_{2}$ as well, then $P_{2}$ might always choose Tails in both subgames and $P_{1}$ 's EV for choosing Play from Heads would become 1 while the EV for Sell would only be 0.5 . Instead, we could allow $P_{1}$ to achieve an EV of 0.5 for reaching each subgame from Heads (by setting the alternative payoff for Heads to 0.5 ). In that case, $P_{1}$ 's overall EV for choosing Play could only increase to 0.5 , even if both $S_{1}$ and $S_{2}$ were solved independently.

[^2]We capture this intuition by considering for each $I_{1} \in S_{\text {top }}$ all the infosets and actions $I_{1}^{\prime} \cdot a^{\prime} \sqsubset I_{1}$ that $P_{1}$ would have taken along the path to $I_{1}$. If, at some $I_{1}^{\prime} \cdot a^{\prime} \sqsubset I_{1}$ where $P_{1}$ acted, there was a different action $a^{*} \in A\left(I_{1}^{\prime}\right)$ that leads to a higher EV, then $P_{1}$ would have taken a suboptimal action if they reached $I_{1}$. The difference in value between $a^{*}$ and $a^{\prime}$ is referred to as a gift. We can afford to let $P_{1}$ 's value for $I_{1}$ increase beyond the blueprint value (and in the process lower $P_{1}$ 's value in some other infoset in $S_{\text {top }}$ ), so long as the increase to $I_{1}$ 's value is small enough that choosing actions leading to $I_{1}$ is still suboptimal for $P_{1}$. Critically, we must ensure that the increase in value is small enough even when the potential increase across all subgames is summed together, as in Figure $4^{4}$
A complicating factor is that gifts we assumed were present may actually not exist. For example, in Coin Toss, suppose applying subgame solving to the Sell subgame results in $P_{1}$ 's value for Sell from the Heads state decreasing from 0.5 to 0.25 . If we independently solve the Play subgame, we have no way of knowing that $P_{1}$ 's value for Sell is lower than the blueprint suggested, so we may still assume there is a gift of 0.5 from the Heads state based on the blueprint. Thus, in order to guarantee a theoretical result on exploitability that is as strong as possible, we use in our theory and experiments a lower bound on what gifts could be after subgame solving was applied to all other subgames.

Formally, let $\sigma_{2}$ be a $P_{2}$ blueprint and let $\sigma_{2}^{-S}$ be the $P_{2}$ strategy that results from applying subgame solving independently to a set of disjoint subgames other than $S$. Since we do not want to compute $\sigma_{2}^{-S}$ in order to apply subgame solving to $S$, let $\left\lfloor g^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)\right\rfloor$ be a lower bound of $C B V^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}\right)-C B V^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)$ that does not require knowledge of $\sigma_{2}^{-S}$. In our experiments we use $\left\lfloor g^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)\right\rfloor=\max _{a \in A_{z}\left(I_{1}^{\prime}\right) \cup\left\{a^{\prime}\right\}} C B V^{\sigma_{2}}\left(I_{1}^{\prime}, a\right)-C B V^{\sigma_{2}}\left(I_{1}^{\prime}, a^{\prime}\right)$ where $A_{z}\left(I_{1}^{\prime}\right) \subseteq A\left(I_{1}^{\prime}\right)$ is the set of actions leading immediately to terminal nodes. Reach subgame solving modifies the augmented subgame in Resolving and Maxmargin by increasing the alternative payoff for infoset $I_{1} \in S_{\text {top }}$ by $\sum_{I_{1}^{\prime} \cdot a^{\prime} \sqsubseteq I_{1} \mid P\left(I_{1}^{\prime}\right)=P_{1}}\left\lfloor g^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)\right\rfloor$. Formally, we define a reach margin as

$$
\begin{equation*}
M_{r}^{\sigma^{S}}\left(I_{1}\right)=M^{\sigma^{S}}\left(I_{1}\right)+\sum_{I_{1}^{\prime} \cdot a^{\prime} \sqsubseteq I_{1} \mid P\left(I_{1}^{\prime}\right)=P_{1}}\left\lfloor g^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)\right\rfloor \tag{1}
\end{equation*}
$$

This margin is larger than or equal to the one for Maxmargin, because $\left\lfloor g^{\sigma_{2}^{-S}}\left(I^{\prime}, a^{\prime}\right)\right\rfloor$ is nonnegative. We refer to the improved algorithms as Reach-Resolve and Reach-Maxmargin.

Intuitively, the alternative payoff in an augmented subgame determines how important it is that $P_{2}$ "defend" against that $P_{1}$ infoset. If the alternative payoff is increased, then $P_{1}$ is more likely to choose the alternative payoff rather than enter the subgame, so $P_{2}$ can instead focus on lowering the value of other $P_{1}$ infosets in $S_{\text {top }}$.

Using a lower bound on gifts is not necessary to guarantee safety. So long as we use a gift value $g^{\sigma^{\prime}}\left(I_{1}^{\prime}, a^{\prime}\right) \leq C B V^{\sigma_{2}}\left(I_{1}^{\prime}\right)-C B V^{\sigma_{2}}\left(I_{1}^{\prime}, a^{\prime}\right)$, the resulting strategy will be safe. However, using a lower bound further guarantees a reduction to exploitability when a $P_{1}$ best response reaches with positive probability an infoset $I_{1} \in S_{\text {top }}$ that has positive margin, as proven in Theorem 1 In practice, it may be best to use an accurate estimate of gifts. One option is to use $\hat{g}^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)=$ $C \tilde{B} V^{\sigma_{2}}\left(I_{1}^{\prime}\right)-C \tilde{B} V^{\sigma_{2}}\left(I_{1}^{\prime}, a^{\prime}\right)$ in place of $\left\lfloor g^{\sigma_{2}^{-S}}\left(I_{1}^{\prime}, a^{\prime}\right)\right\rfloor$, where $C \tilde{B} V^{\sigma_{2}}$ is the closest $P_{1}$ can get to the value of a counterfactual best response while $P_{1}$ is constrained to playing within the abstraction that generated the blueprint. Using estimates is covered in more detail in Section 6
Theorem 1 shows that when subgames are solved independently and using lower bounds on gifts, Reach-Maxmargin solving has exploitability lower than or equal to past safe techniques. The theorem statement is similar to that of Maxmargin [24], but the margins are now larger (or equal) in size.
Theorem 1. Given a strategy $\sigma_{2}$ in a two-player zero-sum game, a set of disjoint subgames $\mathbb{S}$, and a strategy $\sigma_{2}^{S}$ for each subgame $S \in \mathbb{S}$ produced via Reach-Maxmargin solving using lower bounds for gifts, let $\sigma_{2}^{\prime}$ be the strategy that plays according to $\sigma_{2}^{S}$ for each subgame $S \in \mathbb{S}$, and $\sigma_{2}$

[^3]elsewhere. Moreover, let $\sigma_{2}^{-S}$ be the strategy that plays according to $\sigma_{2}^{\prime}$ everywhere except for $P_{2}$ nodes in $S$, where it instead plays according to $\sigma_{2}$. If $\pi_{1}^{B R\left(\sigma_{2}^{\prime}\right)}\left(I_{1}\right)>0$ for some $I_{1} \in S_{\text {top }}$, then $\exp \left(\sigma_{2}^{\prime}\right) \leq \exp \left(\sigma_{2}^{-S}\right)-\sum_{h \in I_{1}} \pi_{-1}^{\sigma_{2}}(h) M_{r}^{\sigma^{S}}\left(I_{1}\right)$.

So far the described techniques have guaranteed a reduction in exploitability over the blueprint by setting the value of $a_{T}^{\prime}$ equal to the value of $P_{1}$ playing optimally to $P_{2}$ 's blueprint. Relaxing this guarantee by instead setting the value of $a_{T}^{\prime}$ equal to an estimate of $P_{1}$ 's value when both players play optimally leads to far lower exploitability in practice. We discuss this approach in the next section.

## 6 Estimates for Alternative Payoffs

In this section we consider the case where we have a good estimate of what the values of subgames would look like in a Nash equilibrium. Unlike previous sections, exploitability might be higher than the blueprint when using this method; the solution quality ultimately depends on the accuracy of the estimates used. In practice this approach leads to significantly lower exploitability.
When solving multiple $P_{2}$ subgames, there is a minimally-exploitable strategy $\sigma_{2}^{*}$ that could, in theory, be computed by changing only the strategies in the subgames. ( $\sigma_{2}^{*}$ may not be a Nash equilibrium because $P_{2}$ 's strategy outside the subgames is fixed, but it is the closest that can be achieved by changing the strategy only in the subgames). However, $\sigma_{2}^{*}$ can only be guaranteed to be produced by solving all the subgames together, because the optimal strategy in one subgame depends on the optimal strategy in other subgames.
Still, suppose that we know $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$ for every infoset $I_{1} \in S_{\text {top }}$ for every subgame $S$. Let $I_{r, 1}$ be the infoset in $S_{r}$ that leads to $I_{1}$. By setting the $P_{1}$ alternative payoff for $I_{r, 1}$ to $v\left(I_{r, 1}, a_{T}^{\prime}\right)=$ $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$, safe subgame solving guarantees a strategy will be produced with exploitability no worse than $\sigma_{2}^{*}$. Thus, achieving a strategy equivalent to $\sigma_{2}^{*}$ does not require knowledge of $\sigma_{2}^{*}$; rather, it only requires knowledge of $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$ for infosets $I_{1}$ in the top of the subgames.
While we do not know $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$ exactly without knowing $\sigma_{2}^{*}$ itself, we may nevertheless be able to produce (or learn) good estimates of $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$. For example, in Section 8 we compute the solution to the game of No-Limit Flop Hold'em (NLFH), and find that in perfect play $P_{2}$ can expect to win about $37 \mathrm{mbb} / \mathrm{h}^{5}$ (that is, if $P_{1}$ plays perfectly against the computed $P_{2}$ strategy, then $P_{1}$ earns -37 ; if $P_{2}$ plays perfectly against the computed $P_{1}$ strategy, then $P_{2}$ earns 37 ). An abstraction of the game which is only $0.02 \%$ of the size of the full game produces a $P_{1}$ strategy that can be beaten by $112 \mathrm{mbb} / \mathrm{h}$, and a $P_{2}$ strategy that can be beaten by $21 \mathrm{mbb} / \mathrm{h}$. Still, the abstract strategy estimates that at equilibrium, $P_{2}$ can expect to win $35 \mathrm{mbb} / \mathrm{h}$. So even though the abstraction produces a very poor estimate of the strategy $\sigma^{*}$, it produces a good estimate of the value of $\sigma^{*}$. In our experiments, we estimate $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$ by calculating a $P_{1}$ counterfactual best response within the abstract game to $P_{2}$ 's blueprint. We refer to this strategy as $C \tilde{B} R\left(\sigma_{2}\right)$ and its value in an infoset $I_{1}$ as $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$. We then use $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$ as the alternative payoff of $I_{1}$ in an augmented subgame. In other words, rather than calculate a $P_{1}$ counterfactual best response in the full game to $P_{2}$ 's blueprint strategy (which would be $C B R\left(\sigma_{2}\right)$ ), we instead calculate $P_{1}$ 's counterfactual best response where $P_{1}$ is constrained by the abstraction.
If the blueprint was produced by conducting $T$ iterations of CFR in an abstract game, then one could instead simply use the final iteration's strategy $\sigma_{1}^{T}$, as this converges to a counterfactual best response within the abstract game. This is what we use in our experiments in this paper.
Theorem 2 proves that if we use estimates of $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$ as the alternative payoffs in Maxmargin subgame solving, then we can bound exploitability by the distance of the estimates from the true values. This is in contrast to the previous algorithms which guaranteed exploitability no worse than the blueprint.
Theorem 2. Let $\mathbb{S}$ be a set of disjoint subgames being solved in a game with no private actions. Let $\sigma$ be a blueprint and let $\sigma_{2}^{*}$ be a minimally-exploitable $P_{2}$ strategy that differs from $\sigma_{2}$ only in $\mathbb{S}$. Let

[^4]$\Delta=\max _{S \in \mathbb{S}, I_{1} \in S_{\text {top }}}\left|C B V^{\sigma_{2}^{*}}\left(I_{1}\right)-C B V^{\sigma_{2}}\left(I_{1}\right)\right|$. Applying Maxmargin solving to each subgame using $\sigma$ as the blueprint produces a $P_{2}$ strategy with exploitability no higher than $\exp \left(\sigma_{2}^{*}\right)+2 \Delta$.

Using estimates of the values of $\sigma^{*}$ tends to be do better than the theoretically safe options described in Section $4^{6}$
Although Theorem 2 uses Maxmargin in the proof, in practice Resolve does far better with estimates than Maxmargin. Additionally, the theorem easily extends to Reach-Maxmargin as well, and ReachResolve does better than Resolve regardless of whether estimates are used.
Section B. 1 discusses an improvement, which we refer to as Distributional alternative payoffs, that leads to even better performance by making the algorithm more robust to errors in the blueprint estimates.

## 7 Nested Subgame Solving

As we have discussed, large games must be abstracted to reduce the game to a tractable size. This is particularly common in games with large or continuous action spaces. Typically the action space is discretized by action abstraction so that only a few actions are included in the abstraction. While we might limit ourselves to the actions we included in the abstraction, an opponent might choose actions that are not in the abstraction. In that case, the off-tree action can be mapped to an action that is in the abstraction, and the strategy from that in-abstraction action can be used. For example, in an auction game we might include a bid of $\$ 100$ in our abstraction. If a player bids $\$ 101$, we simply treat that as a bid of $\$ 100$. This is referred to as action translation [16, 31, 10]. Action translation is the state-of-the-art prior approach to dealing with this issue. It has been used, for example, by all the leading competitors in the Annual Computer Poker Competition (ACPC).

In this section, we develop techniques for applying subgame solving to calculate responses to opponent off-tree actions, thereby obviating the need for action translation. That is, rather than simply treat a bid of $\$ 101$ as $\$ 100$, we calculate in real time a unique response to the bid of $\$ 101$. This can also be done in a nested fashion in response to subsequent opponent off-tree actions. We present two methods that dramatically outperform the leading action translation technique. Additionally, these techniques can be used to solve finer-grained models as play progresses down the game tree. For exposition, we assume that $P_{2}$ wishes to respond to $P_{1}$ choosing an off-tree action.
We refer to the first method as the inexpensive method When $P_{1}$ chooses an off-tree action $a$, a subgame $S$ is generated following that action such that for any infoset $I_{1}$ that $P_{1}$ might be in, $I_{1} \cdot a \in S_{\text {top }}$. This subgame may itself be an abstraction. A solution $\sigma^{S}$ is computed via subgame solving, and $\sigma^{S}$ is combined with $\sigma$ to form a new blueprint $\sigma^{\prime}$ in the expanded abstraction that now includes action $a$. The process repeats whenever $P_{1}$ again chooses an off-tree action.

To conduct safe subgame solving in response to off-tree action $a$, we could calculate $C B V^{\sigma_{2}}\left(I_{1}, a\right)$ by defining, via action translation, a $P_{2}$ blueprint following $a$ and best responding to it [5]. However, that could be computationally expensive and would likely perform poorly in practice because, as we show later, action translation is highly exploitable. Instead, we relax the guarantee of safety and use $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$ for the alternative payoff, where $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$ is the value in $I_{1}$ of $P_{1}$ playing as close to optimal as possible while constrained to playing in the blueprint abstraction (which excludes action $a$ ). In this case, exploitability depends on how well $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$ approximates $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$, where $\sigma_{2}^{*}$ is an optimal $P_{2}$ strategy (see Section 6$)^{8}$ In general, we find that only a small number of near-optimal actions need to be included in the blueprint abstraction for $C \tilde{B} V^{\sigma_{2}}\left(I_{1}\right)$ to be close to $C B V^{\sigma_{2}^{*}}\left(I_{1}\right)$. We can then approximate a near-optimal response to any opponent action. This is particularly useful in very large or continuous action spaces.
The "inexpensive" approach cannot be combined with Unsafe subgame solving because the probability of reaching an action outside of a player's abstraction is undefined. Nevertheless, a similar approach

[^5]is possible with Unsafe subgame solving (as well as all the other subgame-solving techniques) by starting the subgame solving at $h$ rather than at $h \cdot a$. In other words, if action $a$ taken in node $h$ is not in the abstraction, then Unsafe subgame solving is conducted in the smallest subgame containing $h$ (and action $a$ is added to that abstraction). This increases the size of the subgame compared to the inexpensive method because a strategy must be recomputed for every action $a^{\prime} \in A(h)$ in addition to $a$. For example, if an off-tree action is chosen by the opponent as the first action in the game, then the strategy for the entire game must be recomputed. We therefore call this method the expensive method. We present experiments with both methods.
